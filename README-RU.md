# 1. Зависимости и сборка библиотеки

Библиотека и тесты собираются с помощью CMake, в качестве package manager-а используется vcpkg.
Для установки нужно следовать инструкциям тут: https://github.com/Microsoft/vcpkg

Когда vcpkg установлен, нужно установить следующие библиотеки (через vcpkg install):

 * boost
 * spdlog
 * fmt
 * rapidjson
 * openssl
 * gtest

Далее нужно задаить переменную среды VCPKG_ROOT указывающую на директорию в которую установлен vcpkg.
Альтернативно, можно передать переменную VCPKG_ROOT при генерации проекта CMake-ом (-DVCPKG_ROOT=/path/to/vcpkg).

Дальше можно собрать библиотеку и тесты любым удобным тулчейном поддерживаемым CMake.

Тесты можно запустить через CTest или по одному.
На линуксе возможно нужно увеличить лимит на количество дескрипторов для запуска некоторых тестов.
Каждый том это 3 дескриптора.

## 1.1 Сборка бандла для web теста

В директории webtest/webui лежит исходный код интерфейсной части приложения для интерактичного
тестирования библиотеки. Для сборки нужен nodejs.
Что бы установить зависимости, нужно исполнить:

    npm i

в директории webtest/webui. Что бы собрать сам бандл:

    npm run build

или

    npm run build_release

К сожалению плагин UglifyJs всё еще не поддерживает ES6 синтаксис, так 
что для сборки релизной версии нужно tsconfig.json параметр target поменять на es5.
Предсобранный релизный бандл лежит в директории webtest/webui/release.

Для запуска приложения нужно скопировать содержимое папки webtest/webui/dist если
webui был собран, или webtest/webui/release если используется предсобранная версия
в поддиректорию webroot в той же директории где расположен phkvs_webtest(.exe).

Запустить можно с опцией

    phkvs_webtest -o

что бы страничка сразу открылась в браузере.

# 2. Организация и формат данных

Каждый volume состоит из 3-х файлов с расширениями .phkvsmain .phkvsstm и .phkvsbig 

 * .phkvsmain - основной файл, представляет из себя дерево из block-skip-list-ов.

 * .phkvsstm - хранилище для данных маленького и среднего размера, от 16 до 256 байт, используется как
для внутренних структур данных skip list-а, так и для пользовательских данных
не слишком больших для inplace хранения в основном файле.

 * .phkvsbig - хранилище для строк и блобов больше 256 байт.

Все целочисленные значения хранятся в little endian формате.

## 2.1 Формат основного файла .phkvsmain

Заголовок:

|Поле                    | Тип/Размер | Значение | Описание                                                                               |
|------------------------|------------|----------|----------------------------------------------------------------------------------------|
|Magic                   | uint8_t[4] | 'PHVS'   | Для проверки типа файла                                                                |
|Version.Major           | uint16_t   | 1        | Старшая часть версии                                                                   |
|Version.Minor           | uint16_t   | 0        | Младшая часть версии                                                                   |
|Head fist free node     | uint64_t   |          | Смещение первой свободной головной ноды skip-list-а. 0 если нет свободных головных нод.|
|List free free node     | uint64_t   |          | Смещение первой свободной ноды skip-list-а. 0 если нет свобоных нод.                   |

Сразу за заголовком идёт головная нода корневой директории.

Головная нода:

|Поле                    | Тип/Размер | Описание                                                                               |
|------------------------|------------|----------------------------------------------------------------------------------------|
|nexts level             | uint8_t    | Количество уровней в массиве указателей на следующую ноду                              |
|next offset/stm offset  | uint64_t   | Смещение следующей ноды если nexts level == 1 или смещение в phkvsstm файле если >1    |

Каждый skip-list всегда начинается с головной ноды без значений.

Нода с данными block-skip-list-а:

|Поле                    | Тип/Размер | Описание                                                                               |
|------------------------|------------|----------------------------------------------------------------------------------------|
|nexts level             | uint8_t    | Количество уровней в массиве указателей на следующую ноду                              |
|next offset/stm offset  | uint64_t   | Смещение следующей ноды если nexts level == 1 или смещение в phkvsstm файле если >1    |
|used entries count      | uint8_t    | Количество заполненных элементов с данными                                             |
|entry array             | Entry[16]  | Элементы с данными                                                                     |

Нода имеет фиксированный размер. Не занятые ячейки с данными заполненны нулями.
Массив entry array всегда отсортирован по возрастанию имени.

Элемент данных(Entry):

|Поле                    | Тип/Размер | Описание                                                                               |
|------------------------|------------|----------------------------------------------------------------------------------------|
|flags                   | uint8_t    | Поле с флагами                                                                         |
|expirtion date          | uint64_t   | Дата истечения срока жизни ключа в миллискундах с epoch. 0 если не задана.             |
|name                    | Name(16)   | имя                                                                                    |
|value                   | Value(16)  | значение                                                                               |

Поле flags:

 * 7-й бит (0x80) - Entry содержит директорию
 * 6-й бит (0x40) - Inplace name
 * 5-й бит (0x20) - Inplace value
 * с 0 по 3-й биты (0x0f) - индекс типа значения

Если 7-й бит уствновлен, то name содержит имя директории, а value смещение головной ноды skip-list-а с содержимым директории.

Если бит Inplace name установлен, то поле name содержит zero terminated строку или, если нуля нет, то все 16 байт это имя.
Поле всегда дополненно до 16-ти байт.

Если бит Inplace name не установлен, но поле name содержит размер и смещение имени во внешнем хранилище:

|Поле                    | Тип/Размер | Описание                            |
|------------------------|------------|-------------------------------------|
|length                  | uint64_t   | Длина имени                         |
|offset                  | uint64_t   | Смещение имени во внешнем хранилище |

Если length <=256, то есть имя влезает в stm хранилище, то offset это смещение в этом хранилище, иначе в big хранилище.

Если бит Inplace value установлен, то 1-й байт поля value это реальный размер, и само значение за ним. Дополненно нулями до 16 байт.

|Поле                    | Тип/Размер     | Описание             |
|------------------------|----------------|----------------------|
|size                    | uint8_t        | Длина blob значения  |
|data                    | uint8_t[0..15] | Данные blob значения |

Если бит Inplace value не установлен, то поле value содержит размер и смещенеие blob значения во внешнем хранилище.

|Поле                    | Тип/Размер | Описание                            |
|------------------------|------------|-------------------------------------|
|size                    | uint64_t   | Размер blob значения                |
|offset                  | uint64_t   | Смещение во внешнем хранилище       |

Если size <=256, то есть blob значение влезает в stm хранилище, то offset это смещение в этом хранилище, иначе в big хранилище.

Тип значения:

| Индекс | Тип       |
|--------|-----------|
|0       | uint8_t   |
|1       | uint16_t  |
|2       | uint32_t  |
|3       | uint64_t  |
|4       | float     |
|5       | double    |
|6       | string    |
|7       | blob      |

Типы кроме string и blob всегда хранятся inplace, но поле value всегда дополнено до 16-ти байт.

## 2.2 Формат файла .phkvsstm

Этот файл представляет из себя набор пулов для размеров от 16 до 256 с шагом 8.
*ВАЖНО* - в файле НЕ хранится размер аллоцированного блока. Это ответственность пользователя
знать размер сохранённого объекта.

Заголовок:

|Поле                    | Тип/Размер   | Значение | Описание                                                           |
|------------------------|--------------|----------|--------------------------------------------------------------------|
|Magic                   | uint8_t[4]   | 'SMFS'   | Для проверки типа файла                                            |
|Version.Major           | uint16_t     | 1        | Старшая часть версии                                               |
|Version.Minor           | uint16_t     | 0        | Младшая часть версии                                               |
|First free node array   | uint64_t[31] |          | Массив смещений первых свободных элементов соответствующего размер |

0-й элемент массива это смещение первого свободного блока размером 16, 1-й 24 и т.д. 31-й блока размером 256.
Свободные блоки организованны в single linked list, где 64-битное смещение хранится в начале блока.
Значение 0 означает, что свободных блоков данного размер нет.

## 2.3 Формат файла .phkvsbig

Блоки данных аллоцированные в этом файле это single linked list страниц размером 512 байт.
*ВАЖНО* - в файле НЕ хранится (точный) размер аллоцированного блока. Это ответственность пользователя
знать размер сохранённого объекта.

Заголовок:

|Поле                    | Тип/Размер   | Значение | Описание                           |
|------------------------|--------------|----------|------------------------------------|
|Magic                   | uint8_t[4]   | 'BGFS'   | Для проверки типа файла            |
|Version.Major           | uint16_t     | 1        | Старшая часть версии               |
|Version.Minor           | uint16_t     | 0        | Младшая часть версии               |
|First free page offset  | uint64_t     |          | Смещение первой свободной страницы |

Каждая страница имеет размер 512 байт и начинается с 64-битного смещения следующей страницы.
Как для цепочек пользовательских данных, так и для цепочек свобоных страниц 0 в смещении означает
последнюю страницу в цепочке.

# 3. Как искать в block-skip-list.

Алгоритм очень простой. Каждый узел содержит массив смещений на следующий узел по уровням.
У головного узла этот массив всегда максимальной высоты (16 в текущей реализации).
Сам поиск выглядит так, начиная с самого высокого уровня:

Если первый элемент в узле на который ссылается текущий уровень больше либо равен искомому значению,
то переходим в этот узел. Иначе опускаемся на уровень ниже и продолжаем. Если уже на 0-м уровне, прекращаем
поиск.

Мы получили узел, в котором первый элемент >= искомого. При этом в следующем узле первый элемент < искомого.
Так как значения в узле отсортированы, дальше в массиве значений делается бинарный поиск, и искомое значение либо находится, либо нет.
